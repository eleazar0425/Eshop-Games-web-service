"use strict";var __awaiter=this&&this.__awaiter||function(t,e,r,o){return new(r||(r=Promise))(function(s,n){function i(t){try{_(o.next(t))}catch(t){n(t)}}function a(t){try{_(o.throw(t))}catch(t){n(t)}}function _(t){t.done?s(t.value):new r(function(e){e(t.value)}).then(i,a)}_((o=o.apply(t,e||[])).next())})},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const awesome_querystring_1=require("awesome-querystring"),country_data_1=require("country-data"),fast_xml_parser_1=require("fast-xml-parser"),node_fetch_1=__importDefault(require("node-fetch")),constants_1=require("./constants"),interfaces_1=require("./interfaces"),arrayRemoveDuplicates=(t,e)=>{const r=[];return t.filter(t=>{const o=e?t[e]:t;return!(r.indexOf(o)>=0)&&r.push(o)})};exports.getGamesAmerica=((t={shop:"ncom",limit:constants_1.US_GAME_LIST_LIMIT},e=0,r=[])=>__awaiter(this,void 0,void 0,function*(){t.limit||(t.limit=constants_1.US_GAME_LIST_LIMIT),t.shop||(t.shop="ncom");const o="all"===t.shop?["ncom","retail"]:t.shop;try{const s=yield node_fetch_1.default(`${constants_1.US_GET_GAMES_URL}?${awesome_querystring_1.stringify(Object.assign({limit:t.limit,offset:e,shop:o},constants_1.US_GET_GAMES_OPTIONS))}`);if(!s.ok)throw new Error("US_games_request_failed");const n=yield s.json(),i=arrayRemoveDuplicates(r.concat(n.games.game),"slug");return!t.limit&&n.games.game.length+e<n.filter.total&&(yield exports.getGamesAmerica(t,e+t.limit,i)),i}catch(t){if(/(?:US_games_request_failed)/i.test(t.toString()))throw new constants_1.EshopError("Fetching of US Games failed");return t}})),exports.getGamesJapan=(()=>__awaiter(this,void 0,void 0,function*(){try{const t=yield node_fetch_1.default(constants_1.JP_GET_GAMES_CURRENT),e=yield node_fetch_1.default(constants_1.JP_GET_GAMES_COMING);if(!t.ok)throw new Error("JP_current_games_US_games_request_failed");if(!e.ok)throw new Error("JP_coming_games_US_games_request_failed");const r=fast_xml_parser_1.parse(yield t.text()),o=fast_xml_parser_1.parse(yield e.text()),s=r.TitleInfoList.TitleInfo,n=o.TitleInfoList.TitleInfo;return s.concat(n)}catch(t){if(/(?:JP_current_games_US_games_request_failed)/i.test(t.toString()))throw new constants_1.EshopError("Fetching of Current JP Games failed");if(/(?:JP_coming_games_US_games_request_failed)/i.test(t.toString()))throw new constants_1.EshopError("Fetching of Upcoming JP Games failed");return t}})),exports.getGamesEurope=((t={limit:constants_1.EU_GAME_LIST_LIMIT,locale:constants_1.EU_DEFAULT_LOCALE})=>__awaiter(this,void 0,void 0,function*(){t.limit||(t.limit=constants_1.EU_GAME_LIST_LIMIT),t.locale||(t.locale=constants_1.EU_DEFAULT_LOCALE);try{const e=yield node_fetch_1.default(`${constants_1.EU_GET_GAMES_URL.replace("{locale}",t.locale)}?${awesome_querystring_1.stringify({fq:"type:GAME AND system_type:nintendoswitch* AND product_code_txt:*",q:"*",rows:t.limit,sort:"sorting_title asc",start:"0",wt:"json"})}`);if(!e.ok)throw new Error("EU_games_request_failed");return(yield e.json()).response.docs}catch(t){if(/(?:EU_games_request_failed)/i.test(t.toString()))throw new constants_1.EshopError("Fetching of EU Games failed");return t}})),exports.getPrices=((t,e,r=0,o=[])=>__awaiter(this,void 0,void 0,function*(){try{const s=e.slice(r,r+constants_1.PRICE_LIST_LIMIT),n=yield node_fetch_1.default(`${constants_1.PRICE_GET_URL}?${awesome_querystring_1.stringify(Object.assign({country:t,ids:s,limit:constants_1.PRICE_LIST_LIMIT},constants_1.PRICE_GET_OPTIONS))}`);if(403===n.status)throw new Error("PRICE_Rate_Limit");if(!n.ok)throw new Error("PRICE_get_request_failed");const i=yield n.json();if(i.prices&&i.prices.length+r<e.length){const s=o.concat(i.prices);exports.getPrices(t,e,r+constants_1.PRICE_LIST_LIMIT,s)}else if(i.prices)return i.prices=i.prices.concat(o),i;return i}catch(t){if(/(?:PRICE_Rate_Limit)/i.test(t.toString()))throw new constants_1.EshopError("Looks like you ran into a rate limit while getting price data, please do not spam the Nintendo servers.");if(/(?:PRICE_get_request_failed)/i.test(t.toString()))throw new constants_1.EshopError("Fetching of eShop prices failed");return t}})),exports.getShopsByCountryCodes=((t,e,r)=>__awaiter(this,void 0,void 0,function*(){try{const o=t.map(t=>country_data_1.countries.all.filter(e=>e.alpha2===t)[0]),s=[];for(const t of o)try{const r=yield exports.getPrices(t.alpha2,e);r.country=t,s.push(r)}catch(t){continue}const n=s.filter(t=>t&&t.prices&&t.prices.length&&t.prices[0].regular_price).map(t=>({code:t.country.alpha2,country:t.country.name,currency:t.prices[0].regular_price.currency,region:r}));if(!n.length)throw new Error("ACTIVE_SHOPS_Rate_Limit");return n}catch(t){if(/(?:ACTIVE_SHOPS_Rate_Limit)/i.test(t.toString()))throw new constants_1.EshopError("Looks like you ran into a rate limit while getting price data, please do not spam the Nintendo servers.");return t}})),exports.getShopsAmerica=(()=>__awaiter(this,void 0,void 0,function*(){return exports.getShopsByCountryCodes(country_data_1.regions.southAmerica.countries.concat(country_data_1.regions.centralAfrica.countries,country_data_1.regions.northernAmerica.countries),constants_1.US_GAME_CHECK_CODE,interfaces_1.Region.AMERICAS)})),exports.getShopsEurope=(()=>__awaiter(this,void 0,void 0,function*(){return exports.getShopsByCountryCodes(country_data_1.regions.northernEurope.countries.concat(country_data_1.regions.southernEurope.countries,country_data_1.regions.easternEurope.countries,country_data_1.regions.westernEurope.countries,country_data_1.regions.australia.countries,country_data_1.regions.southernAfrica.countries),constants_1.EU_GAME_CHECK_CODE,interfaces_1.Region.EUROPE)})),exports.getShopsAsia=(()=>__awaiter(this,void 0,void 0,function*(){return exports.getShopsByCountryCodes(country_data_1.regions.southernAsia.countries.concat(country_data_1.regions.southernAsia.countries,country_data_1.regions.southeastAsia.countries,country_data_1.regions.eastAsia.countries,country_data_1.regions.westernAsia.countries),constants_1.JP_GAME_CHECK_CODE,interfaces_1.Region.ASIA)})),exports.getActiveShops=(()=>__awaiter(this,void 0,void 0,function*(){const t=yield exports.getShopsAmerica(),e=yield exports.getShopsAsia(),r=yield exports.getShopsEurope();return t.concat(e,r)})),exports.parseGameCode=((t,e)=>{let r;switch(e){case interfaces_1.Region.EUROPE:r=constants_1.EU_GAME_CODE_REGEX.exec(t.product_code_txt[0]);break;case interfaces_1.Region.ASIA:r=constants_1.JP_GAME_CODE_REGEX.exec(t.ScreenshotImgURL[0]);break;default:case interfaces_1.Region.AMERICAS:r=constants_1.US_GAME_CODE_REGEX.exec(t.game_code)}return r&&r.length>1?r[1]:null}),exports.parseNSUID=((t,e)=>{switch(e){case interfaces_1.Region.EUROPE:return t.nsuid_txt?t.nsuid_txt[0]:null;case interfaces_1.Region.ASIA:const r=constants_1.JP_NSUID_REGEX.exec(t.LinkURL[0]);return r&&r.length>0?r[0]:null;default:case interfaces_1.Region.AMERICAS:return t.nsuid}});